# üéØ Professional State Machine System

## Arquitectura Enterprise para Godot 4.4

> Sistema de m√°quina de estados profesional desarrollado con m√°s de 10 a√±os de experiencia en arquitectura de software empresarial.

---

## üìã Tabla de Contenidos

1. [Descripci√≥n General](#descripci√≥n-general)
2. [Arquitectura del Sistema](#arquitectura-del-sistema)
3. [Instalaci√≥n y Configuraci√≥n](#instalaci√≥n-y-configuraci√≥n)
4. [Gu√≠a de Uso](#gu√≠a-de-uso)
5. [Funcionalidades Avanzadas](#funcionalidades-avanzadas)
6. [Monitoreo y Analytics](#monitoreo-y-analytics)
7. [Mejores Pr√°cticas](#mejores-pr√°cticas)
8. [API Reference](#api-reference)
9. [Troubleshooting](#troubleshooting)

---

## üéØ Descripci√≥n General

El **Professional State Machine System** es una soluci√≥n empresarial completa para la gesti√≥n de estados en juegos desarrollados con Godot Engine. Dise√±ado con patrones de arquitectura probados en la industria, ofrece:

### üåü Caracter√≠sticas Principales

- **üîÑ Gesti√≥n Avanzada de Estados**: Sistema robusto con validaci√≥n autom√°tica
- **üìä Analytics Integrados**: M√©tricas en tiempo real y reportes detallados
- **üõ°Ô∏è Sistema de Transiciones**: Condiciones complejas y validadores personalizados
- **üìà Monitoreo de Rendimiento**: Detecci√≥n proactiva de problemas
- **üîß Debugging Avanzado**: Herramientas profesionales de desarrollo
- **üíæ Persistencia Autom√°tica**: Save/Load autom√°tico del estado del sistema
- **üéõÔ∏è Configuraci√≥n Flexible**: Adaptable a cualquier tipo de juego

### üèÜ Ventajas Competitivas

- ‚úÖ **Escalabilidad**: Dise√±ado para proyectos grandes y complejos
- ‚úÖ **Mantenibilidad**: C√≥digo limpio y bien documentado
- ‚úÖ **Performance**: Optimizado para juegos en tiempo real
- ‚úÖ **Flexibilidad**: Configurable para diferentes arquitecturas
- ‚úÖ **Debugging**: Herramientas avanzadas de an√°lisis y depuraci√≥n

---

## üèóÔ∏è Arquitectura del Sistema

### Componentes Principales

```
Core/
‚îú‚îÄ‚îÄ StateMachine/
‚îÇ   ‚îú‚îÄ‚îÄ ProfessionalStateMachine.gd     # Motor principal
‚îÇ   ‚îú‚îÄ‚îÄ State.gd                        # Clase base para estados
‚îÇ   ‚îú‚îÄ‚îÄ StateMachine_Original.gd        # Versi√≥n original (backup)
‚îÇ   ‚îî‚îÄ‚îÄ Advanced/
‚îÇ       ‚îú‚îÄ‚îÄ StateTransition.gd          # Sistema de transiciones
‚îÇ       ‚îú‚îÄ‚îÄ StateCondition.gd           # Condiciones de validaci√≥n
‚îÇ       ‚îî‚îÄ‚îÄ StateAnalytics.gd           # Sistema de m√©tricas
‚îî‚îÄ‚îÄ Events/
    ‚îú‚îÄ‚îÄ GameEvent.gd                    # Sistema de eventos tipados
    ‚îî‚îÄ‚îÄ EventBus.gd                     # Bus global de eventos
```

### Flujo de Datos

```mermaid
graph TD
    A[EventBus] --> B[ProfessionalStateMachine]
    B --> C[StateTransition]
    C --> D[StateCondition]
    D --> E[State]
    E --> F[StateAnalytics]
    F --> G[Performance Monitor]
    G --> H[Error Tracker]
```

### Patrones de Dise√±o Implementados

- **üé≠ State Pattern**: Gesti√≥n de estados con polimorfismo
- **üëÄ Observer Pattern**: Sistema de eventos y notificaciones
- **üè≠ Factory Pattern**: Creaci√≥n de transiciones y condiciones
- **üîç Strategy Pattern**: Validadores personalizables
- **üìä Analytics Pattern**: Recolecci√≥n y an√°lisis de m√©tricas

---

## üöÄ Instalaci√≥n y Configuraci√≥n

### 1. Estructura de Archivos

Aseg√∫rate de que tu proyecto tenga la siguiente estructura:

```
tu_proyecto/
‚îú‚îÄ‚îÄ Core/
‚îÇ   ‚îú‚îÄ‚îÄ StateMachine/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProfessionalStateMachine.gd
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ State.gd
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Advanced/
‚îÇ   ‚îî‚îÄ‚îÄ Events/
‚îú‚îÄ‚îÄ Examples/
‚îÇ   ‚îî‚îÄ‚îÄ ProfessionalStateMachineExample.gd
‚îî‚îÄ‚îÄ Scenes/
    ‚îî‚îÄ‚îÄ [tus estados como nodos]
```

### 2. Configuraci√≥n en Project Settings

1. **Autoloads**: A√±adir `EventBus.gd` como singleton global
2. **Input Map**: Configurar hotkeys para debugging (F1-F5)
3. **Memory Settings**: Ajustar seg√∫n las necesidades del proyecto

### 3. Configuraci√≥n B√°sica

```gdscript
# En tu scene principal
extends Node

@onready var state_machine: ProfessionalStateMachine = $ProfessionalStateMachine

func _ready():
    # Configuraci√≥n b√°sica
    state_machine.debug_mode = true
    state_machine.enable_analytics = true
    state_machine.enable_performance_monitoring = true
    
    # Iniciar con estado espec√≠fico
    state_machine.start_state_machine("MainMenuState")
```

---

## üìö Gu√≠a de Uso

### Creando Estados Personalizados

```gdscript
class_name MyGameState
extends State

func enter(previous_state: State = null):
    print("Entrando a MyGameState desde: ", previous_state.name if previous_state else "ninguno")
    
    # Tu l√≥gica de inicializaci√≥n aqu√≠
    setup_ui()
    initialize_systems()

func exit():
    print("Saliendo de MyGameState")
    
    # Cleanup necesario
    cleanup_ui()
    save_state_data()

func update(delta: float):
    # L√≥gica del frame
    update_game_logic(delta)

func handle_input(event: InputEvent):
    # Manejo de input espec√≠fico del estado
    if event is InputEventKey and event.pressed:
        match event.keycode:
            KEY_ESCAPE:
                transition_to("PausedState")
```

### Configurando Transiciones Avanzadas

```gdscript
func setup_transitions():
    # Transici√≥n simple
    state_machine.add_simple_transition("MainMenu", "Game", "start_game")
    
    # Transici√≥n con condiciones
    var health_condition = StateCondition.health_above(0.0)
    state_machine.add_conditional_transition("Game", "GameOver", "player_died", health_condition)
    
    # Transici√≥n temporal
    state_machine.add_timed_transition("Loading", "MainMenu", 3.0)
    
    # Transici√≥n desde cualquier estado
    state_machine.add_simple_transition("*", "Paused", "pause_pressed")
```

### Trabajando con Condiciones

```gdscript
# Condiciones predefinidas
var health_low = StateCondition.health_below(25.0)
var has_key = StateCondition.has_item("master_key")
var level_complete = StateCondition.level_completed()

# Condici√≥n personalizada
var custom_condition = StateCondition.custom("Complex Check", func(data):
    return data.has("score") and data.score > 1000 and data.has("time_remaining")
)
```

---

## üîß Funcionalidades Avanzadas

### Sistema de Validadores

```gdscript
# Validador de recursos del sistema
func setup_validators():
    var memory_validator = func(from: String, to: String) -> bool:
        if to == "GameplayState":
            var mem_usage = OS.get_static_memory_peak_usage()
            return mem_usage < 1024 * 1024 * 512  # Menos de 512MB
        return true
    
    state_machine.add_transition_validator(memory_validator)
```

### Persistencia Autom√°tica

```gdscript
# Habilitar auto-save
state_machine.enable_state_persistence = true
state_machine.auto_save_interval = 30.0  # Cada 30 segundos

# Save/Load manual
var save_data = state_machine.get_complete_state_data()
# ... guardar save_data en archivo ...

# Cargar datos
state_machine.load_complete_state_data(save_data)
```

### Sistema de Undo/Redo

```gdscript
# Habilitar historial
state_machine.enable_undo_redo = true
state_machine.max_history_size = 100

# Uso program√°tico
state_machine.undo_last_transition()  # Volver al estado anterior
```

---

## üìä Monitoreo y Analytics

### M√©tricas Disponibles

El sistema recolecta autom√°ticamente:

- **Estados**: Tiempo de permanencia, frecuencia de uso, transiciones
- **Transiciones**: Tasa de √©xito, tiempo de ejecuci√≥n, fallos
- **Rendimiento**: Tiempo de frame, uso de memoria, latencia
- **Errores**: Log detallado de problemas y contexto

### Generando Reportes

```gdscript
# Reporte completo
var report = state_machine.generate_full_report()
print(report)

# M√©tricas espec√≠ficas
var summary = state_machine.get_analytics_summary()
var state_metrics = state_machine.get_state_metrics("GameplayState")

# Exportar a archivo
state_machine.export_analytics_to_file("user://analytics.txt")
```

### Ejemplo de Reporte

```
=== STATE MACHINE ANALYTICS REPORT ===
Session Duration: 1847.32 seconds
Total Transitions: 45
Unique States: 6
Transitions per Minute: 1.46

=== TOP STATES ===
1. GameplayState - 12 entries, 1654.23s total
2. PausedState - 8 entries, 124.45s total
3. MainMenuState - 3 entries, 45.67s total

=== TOP TRANSITIONS ===
1. GameplayState->PausedState - 8 executions, 100.0% success
2. PausedState->GameplayState - 7 executions, 100.0% success
3. MainMenuState->GameplayState - 3 executions, 100.0% success
```

---

## üéõÔ∏è Mejores Pr√°cticas

### 1. Organizaci√≥n de Estados

```gdscript
# ‚úÖ BUENO: Estados espec√≠ficos y cohesivos
class_name MainMenuState extends State
class_name GameplayState extends State
class_name PausedState extends State

# ‚ùå MALO: Estados gen√©ricos
class_name GameState extends State  # Muy gen√©rico
class_name MenuState extends State  # Ambiguo
```

### 2. Gesti√≥n de Transiciones

```gdscript
# ‚úÖ BUENO: Transiciones expl√≠citas con validaciones
state_machine.add_conditional_transition(
    "Game", "GameOver", "player_died", 
    StateCondition.health_below(1.0)
)

# ‚ùå MALO: Transiciones directas sin validaci√≥n
transition_to("GameOver")  # Sin contexto ni validaci√≥n
```

### 3. Manejo de Errores

```gdscript
# ‚úÖ BUENO: Manejo proactivo de errores
state_machine.error_occurred.connect(_on_state_error)
state_machine.transition_failed.connect(_on_transition_failed)

func _on_state_error(error_type: String, context: Dictionary):
    # Log detallado y recuperaci√≥n autom√°tica
    logger.error("State error: %s" % error_type, context)
    attempt_error_recovery(error_type, context)
```

### 4. Performance

```gdscript
# ‚úÖ BUENO: Monitoreo de rendimiento
state_machine.performance_warning.connect(_on_performance_warning)

func _on_performance_warning(component: String, metric: String, value: float):
    if metric == "high_latency":
        reduce_graphics_quality()
```

---

## üìñ API Reference

### ProfessionalStateMachine

#### Propiedades de Configuraci√≥n

```gdscript
# Core
@export var debug_mode: bool = false
@export var log_level: LogLevel = LogLevel.INFO

# Transitions
@export var enable_transition_validation: bool = true
@export var max_transition_queue: int = 20
@export var allow_self_transitions: bool = false

# Analytics
@export var enable_analytics: bool = true
@export var enable_performance_monitoring: bool = true

# Persistence
@export var enable_state_persistence: bool = false
@export var enable_undo_redo: bool = false
@export var max_history_size: int = 100
```

#### M√©todos Principales

| M√©todo | Descripci√≥n | Retorno |
|--------|-------------|---------|
| `register_state(name, state)` | Registra un estado | `bool` |
| `change_state(name, data)` | Cambia al estado especificado | `bool` |
| `add_transition(transition)` | A√±ade una transici√≥n | `bool` |
| `start_state_machine(initial)` | Inicia el sistema | `bool` |
| `get_current_state_name()` | Obtiene el estado actual | `String` |
| `get_analytics_summary()` | Obtiene resumen de m√©tricas | `Dictionary` |

#### Se√±ales

```gdscript
signal state_changed(from_state: String, to_state: String, data: Dictionary)
signal state_entered(state_name: String, data: Dictionary)
signal state_exited(state_name: String, data: Dictionary)
signal transition_failed(from_state: String, to_state: String, reason: String)
signal analytics_updated(summary: Dictionary)
signal performance_warning(component: String, metric: String, value: float)
signal error_occurred(error_type: String, context: Dictionary)
```

### StateCondition

#### Factory Methods

```gdscript
# Condiciones predefinidas
StateCondition.health_above(threshold: float)
StateCondition.health_below(threshold: float)
StateCondition.has_item(item_name: String)
StateCondition.player_dead()
StateCondition.level_completed()
StateCondition.key_pressed(key_name: String)
StateCondition.variable_equals(path: String, value: Variant)
StateCondition.custom(name: String, evaluator: Callable)
```

### StateTransition

#### Factory Methods

```gdscript
# Tipos de transici√≥n
StateTransition.create_simple(from: String, to: String, event: String)
StateTransition.create_conditional(from: String, to: String, event: String, condition: StateCondition)
StateTransition.create_timed(from: String, to: String, delay: float)
```

---

## üîß Troubleshooting

### Problemas Comunes

#### 1. "Estado no encontrado"

**Error**: `Estado 'GameplayState' no existe`

**Soluci√≥n**:
```gdscript
# Verificar que el estado est√° registrado
if not state_machine.has_state("GameplayState"):
    state_machine.register_state("GameplayState", gameplay_state_node)
```

#### 2. "Transici√≥n fallida"

**Error**: `No hay transici√≥n v√°lida de 'MainMenu' a 'Game'`

**Soluci√≥n**:
```gdscript
# A√±adir la transici√≥n faltante
state_machine.add_simple_transition("MainMenu", "Game", "start_pressed")

# O verificar condiciones
var condition = StateCondition.custom("Ready Check", func(data):
    return data.has("player_ready") and data.player_ready
)
```

#### 3. "Performance Warning"

**Warning**: `Performance Warning: frame_time.high_latency = 33.45`

**Soluci√≥n**:
```gdscript
# Optimizar el estado actual o reducir calidad
func _on_performance_warning(component: String, metric: String, value: float):
    if metric == "high_latency":
        # Reducir efectos visuales
        Engine.max_fps = 30
        # Simplificar l√≥gica del estado actual
```

### Debug Tools

#### Hotkeys de Desarrollo

- **F1**: Mostrar estado actual
- **F2**: Mostrar m√©tricas de analytics
- **F3**: Undo √∫ltima transici√≥n
- **F4**: Generar reporte completo
- **F5**: Reset analytics

#### Logs Detallados

```gdscript
# Habilitar logging detallado
state_machine.debug_mode = true
state_machine.log_level = ProfessionalStateMachine.LogLevel.TRACE

# Los logs aparecer√°n en formato:
# [14:32:15] üîç [StateMachine] Validando transici√≥n: MainMenu -> Game
```

---

## üöÄ Roadmap y Actualizaciones

### Versi√≥n Actual: 1.0.0

- ‚úÖ Sistema b√°sico de estados y transiciones
- ‚úÖ Analytics y m√©tricas integradas
- ‚úÖ Sistema de validaci√≥n avanzado
- ‚úÖ Persistencia y save/load
- ‚úÖ Debugging tools completos

### Pr√≥ximas Funcionalidades (v1.1.0)

- üîÑ **State Composition**: Estados anidados y jer√°rquicos
- üé≠ **Visual State Editor**: Editor gr√°fico para el IDE
- üåê **Network State Sync**: Sincronizaci√≥n en multijugador
- üì± **Mobile Optimizations**: Optimizaciones espec√≠ficas para m√≥vil
- üé® **UI State Binding**: Binding autom√°tico con interfaces

### Funcionalidades Futuras (v2.0.0)

- ü§ñ **AI State Prediction**: IA para optimizaci√≥n autom√°tica
- üìä **Real-time Analytics Dashboard**: Dashboard web en tiempo real
- üîå **Plugin System**: Sistema de plugins para extensibilidad
- üéÆ **Game-specific Templates**: Templates para g√©neros espec√≠ficos

---

## üìû Soporte y Contribuciones

### Reportar Bugs

Para reportar problemas, incluye:

1. **Versi√≥n de Godot**: 4.4+
2. **Configuraci√≥n del State Machine**: Copia de la configuraci√≥n
3. **Logs de Error**: Output completo del debug
4. **Pasos para Reproducir**: Instrucciones detalladas
5. **Analytics Data**: Si est√° disponible

### Contribuir al Proyecto

1. **Fork** del repositorio
2. **Feature Branch**: `git checkout -b feature/nueva-funcionalidad`
3. **Commits**: Mensajes descriptivos y at√≥micos
4. **Tests**: Incluir pruebas para nueva funcionalidad
5. **Pull Request**: Con descripci√≥n detallada

### Documentaci√≥n Adicional

- üìö **Wiki**: Ejemplos avanzados y tutorials
- üé• **Video Tutorials**: Serie de tutoriales en video
- üí¨ **Discord**: Comunidad para soporte en tiempo real
- üìß **Email**: contacto@statemachine.dev

---

## üìÑ Licencia

MIT License - Ver archivo LICENSE para detalles completos.

---

**Desarrollado con ‚ù§Ô∏è por arquitectos de software con m√°s de 10 a√±os de experiencia en la industria del gaming.**
